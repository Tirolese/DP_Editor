<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }
        .shift-button.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--card-bg, #fff), 0 0 0 4px var(--active-ring, #2563eb);
        }
        #save-indicator {
            transition: opacity 0.5s ease-in-out;
        }
        .card, .calendar-day-bg {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .calendar-day-container {
            transition: transform 0.1s ease-out;
        }
        .calendar-day-container:hover {
            transform: scale(1.08);
        }
        .drag-over {
            border-top: 2px solid #3b82f6; /* blue-500 */
        }
        .category-header {
            cursor: grab;
        }
        .category-header:active {
            cursor: grabbing;
        }
    </style>
    <script>
        // Set theme on initial load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dienstplan-Editor</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Dein Plan wird automatisch im Browser gespeichert.</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="generate-ics" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 focus:ring-blue-500 transition-all disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                        ICS-Datei erstellen
                    </button>
                    <button id="generate-email" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 focus:ring-gray-500 transition-all disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                        Als E-Mail senden
                    </button>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 focus:ring-blue-500">
                    <svg id="theme-icon-light" class="h-6 w-6 hidden dark:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-6 w-6 block dark:hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Card: Calendar -->
            <div class="lg:col-span-3 card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">1. Tage zuweisen</h3>
                    <button id="clear-plan" class="text-sm text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold">Plan zurücksetzen</button>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h2 id="month-year" class="text-xl font-bold"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                    <div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Mo</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Di</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Mi</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Do</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Fr</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Sa</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">So</div>
                </div>
            </div>
            
            <!-- Card: Shift Selection -->
            <div class="lg:col-span-2 card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                     <h3 class="text-xl font-semibold text-gray-900 dark:text-white">2. Schicht auswählen</h3>
                     <span id="save-indicator" class="text-sm text-green-500 opacity-0 font-medium">Gespeichert!</span>
                </div>
                <span id="summary-display" class="block text-sm text-gray-500 dark:text-gray-400 mb-4">Keine Dienste geplant</span>
                <div id="shift-selector-buttons" class="space-y-4 mt-3"></div>
            </div>

            <!-- Card: Summary -->
            <div class="lg:col-span-3 card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                 <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">3. Zusammenfassung & Bearbeitung</h3>
                 <div id="shift-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                     <p id="no-day-selected-msg" class="text-gray-500 dark:text-gray-400">Keine Tage zugewiesen.</p>
                 </div>
            </div>

            <!-- Card: Statistics -->
            <div class="lg:col-span-2 card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">4. Detaillierte Statistik</h3>
                <div class="relative h-48 w-48 mx-auto mb-6">
                    <canvas id="shift-chart"></canvas>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-soll" class="text-xl font-bold text-gray-900 dark:text-white">0 h</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">SOLL Stunden</dt>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-ist" class="text-xl font-bold text-gray-900 dark:text-white">0 h</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">IST Stunden</dt>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-nacht" class="text-xl font-bold text-gray-900 dark:text-white">0 h</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">Nachtstunden</dt>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-feiertag" class="text-xl font-bold text-gray-900 dark:text-white">0 h</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">Feiertagsstd.</dt>
                        </div>
                         <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-urlaub" class="text-xl font-bold text-gray-900 dark:text-white">0 h</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">Urlaubsverbr.</dt>
                        </div>
                         <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                            <dd id="stat-wochenende" class="text-xl font-bold text-gray-900 dark:text-white">0</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">WE-Tage</dt>
                        </div>
                         <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg col-span-2">
                            <dd id="stat-feiertage-anzahl" class="text-xl font-bold text-gray-900 dark:text-white">0</dd>
                            <dt class="text-sm text-gray-500 dark:text-gray-400">Gearbeitete Feiertage</dt>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SHIFT_CONFIG_DEFAULT = [
                { name: 'Notfallrettung', shifts: { 'RD1':{s:'06:30',e:'16:30',c:'#ef4444'},'RD2':{s:'07:00',e:'17:00',c:'#ef4444'},'RD3w':{s:'09:00',e:'19:00',c:'#ef4444'},'RD3s':{s:'09:30',e:'19:30',c:'#ef4444'},'RD4':{s:'11:00',e:'21:00',c:'#ef4444'},'RD5':{s:'10:00',e:'20:00',c:'#ef4444'},'RDN1':{s:'19:00',e:'05:00',c:'#ef4444'},'RDN2':{s:'21:00',e:'07:00',c:'#ef4444'}} },
                { name: 'Technische Rettung', shifts: { 'TR1':{s:'06:45',e:'16:45',c:'#8b5cf6'},'TR2':{s:'10:45',e:'20:45',c:'#8b5cf6'},'TR3':{s:'08:00',e:'18:00',c:'#8b5cf6'},'TRN':{s:'20:45',e:'06:45',c:'#8b5cf6'}} },
                { name: 'Callcenter', shifts: { 'NC64':{s:'06:00',e:'16:00',c:'#f97316'},'NC75':{s:'07:00',e:'17:00',c:'#f97316'},'NC86':{s:'08:00',e:'18:00',c:'#f97316'},'NC108':{s:'10:00',e:'20:00',c:'#f97316'},'NC1210':{s:'12:00',e:'22:00',c:'#f97316'},'NC206':{s:'20:00',e:'06:00',c:'#f97316'}} },
                { name: 'Sonstiges', shifts: { 'S':{c:'#3b82f6',d:!0},'Urlaub':{c:'#3b82f6', isRange: true},'Frei':null} }
            ];
            
            const CATEGORY_ABBREVIATIONS = {
                'Notfallrettung': 'NR',
                'Technische Rettung': 'TR',
                'Callcenter': 'CC',
                'Sonstiges': 'Sonst'
            };

            const HOLIDAYS = new Map([
                ['2025-01-01', 'Neujahr'],['2025-01-06', 'Hl. Drei Könige'],['2025-04-21', 'Ostermontag'],['2025-05-01', 'Staatsfeiertag'],['2025-05-29', 'Christi Himmelfahrt'],['2025-06-09', 'Pfingstmontag'],['2025-06-19', 'Fronleichnam'],['2025-08-15', 'Mariä Himmelfahrt'],['2025-10-26', 'Nationalfeiertag'],['2025-11-01', 'Allerheiligen'],['2025-12-08', 'Mariä Empfängnis'],['2025-12-25', 'Christtag'],['2025-12-26', 'Stephanstag']
            ]);

            let shiftCategories = [];
            let collapsedCategories = new Set();
            let currentDate = new Date();
            let selectedDays = new Map();
            let activeTool = 'Frei';
            let rangeSelectionStart = null;
            let saveTimeout;
            let shiftChart = null;

            const DOM = {
                monthYear: document.getElementById('month-year'),
                calendarGrid: document.getElementById('calendar-grid'),
                shiftList: document.getElementById('shift-list'),
                noDayMsg: document.getElementById('no-day-selected-msg'),
                generateBtn: document.getElementById('generate-ics'),
                emailBtn: document.getElementById('generate-email'),
                shiftSelectorButtons: document.getElementById('shift-selector-buttons'),
                summaryDisplay: document.getElementById('summary-display'),
                saveIndicator: document.getElementById('save-indicator'),
                clearPlanBtn: document.getElementById('clear-plan'),
                statSoll: document.getElementById('stat-soll'),
                statIst: document.getElementById('stat-ist'),
                statFeiertag: document.getElementById('stat-feiertag'),
                statNacht: document.getElementById('stat-nacht'),
                statUrlaub: document.getElementById('stat-urlaub'),
                statWochenende: document.getElementById('stat-wochenende'),
                statFeiertageAnzahl: document.getElementById('stat-feiertage-anzahl'),
                chartCanvas: document.getElementById('shift-chart'),
                themeToggle: document.getElementById('theme-toggle'),
            };

            const getStorageKey = (type) => `dienstplan-${type}`;
            const showSaveIndicator = () => { clearTimeout(saveTimeout); DOM.saveIndicator.style.opacity = 1; saveTimeout = setTimeout(() => { DOM.saveIndicator.style.opacity = 0; }, 2000); };
            const saveData = () => { 
                try { 
                    localStorage.setItem(getStorageKey(`plan-${currentDate.getFullYear()}-${currentDate.getMonth()}`), JSON.stringify(Array.from(selectedDays.entries())));
                    localStorage.setItem(getStorageKey('category-order'), JSON.stringify(shiftCategories.map(c => c.name)));
                    localStorage.setItem(getStorageKey('collapsed-categories'), JSON.stringify(Array.from(collapsedCategories)));
                    showSaveIndicator(); 
                } catch (e) { console.error("Speichern fehlgeschlagen:", e); } 
            };
            
            const loadData = () => {
                try {
                    const savedData = localStorage.getItem(getStorageKey(`plan-${currentDate.getFullYear()}-${currentDate.getMonth()}`));
                    if (savedData) {
                        const parsedMap = new Map(JSON.parse(savedData));
                        parsedMap.forEach((data, key) => {
                            if (typeof data === 'string' || !data.hasOwnProperty('name')) {
                                const shiftName = (typeof data === 'string') ? data : data.name;
                                let config = null;
                                SHIFT_CONFIG_DEFAULT.forEach(cat => { if (cat.shifts[shiftName]) config = cat.shifts[shiftName]; });
                                if (config) {
                                    parsedMap.set(key, { name: shiftName, start: config.s, end: config.e, description: '', isCustom: !!config.d });
                                } else { parsedMap.delete(key); }
                            }
                        });
                        selectedDays = parsedMap;
                    } else { selectedDays = new Map(); }
                } catch (e) { console.error("Laden fehlgeschlagen:", e); selectedDays = new Map(); }
                
                try {
                    const savedOrder = JSON.parse(localStorage.getItem(getStorageKey('category-order')));
                    if (savedOrder) {
                        shiftCategories = savedOrder.map(name => SHIFT_CONFIG_DEFAULT.find(c => c.name === name)).filter(Boolean);
                        SHIFT_CONFIG_DEFAULT.forEach(c => { if (!shiftCategories.find(sc => sc.name === c.name)) shiftCategories.push(c); });
                    } else { shiftCategories = [...SHIFT_CONFIG_DEFAULT]; }
                    const savedCollapsed = JSON.parse(localStorage.getItem(getStorageKey('collapsed-categories')));
                    collapsedCategories = new Set(savedCollapsed || []);
                } catch (e) {
                    shiftCategories = [...SHIFT_CONFIG_DEFAULT];
                    collapsedCategories = new Set();
                }

                fullRender();
            };

            const clearData = () => {
                if (window.confirm("Bist du sicher, dass du den gesamten Plan für diesen Monat löschen möchtest?")) {
                    localStorage.removeItem(getStorageKey(`plan-${currentDate.getFullYear()}-${currentDate.getMonth()}`));
                    selectedDays = new Map();
                    fullRender();
                }
            };
            
            const setActiveTool = (name) => {
                if (activeTool === name && rangeSelectionStart) { rangeSelectionStart = null; }
                activeTool = name;
                document.querySelectorAll('.shift-button').forEach(b => b.classList.toggle('active', b.dataset.shift === name));
                if (name !== 'Urlaub') { rangeSelectionStart = null; }
                renderCalendar();
            };

            const createShiftButtons = () => {
                DOM.shiftSelectorButtons.innerHTML = '';
                let draggedIndex = null;
                shiftCategories.forEach((category, index) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'category-group';
                    groupDiv.dataset.index = index;
                    const header = document.createElement('div');
                    header.className = 'category-header flex items-center justify-between p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700';
                    header.draggable = true;
                    header.ondragstart = (e) => { draggedIndex = index; e.dataTransfer.effectAllowed = 'move'; e.target.style.opacity = '0.5'; };
                    header.ondragend = (e) => e.target.style.opacity = '1';
                    header.ondragover = (e) => { e.preventDefault(); groupDiv.classList.add('drag-over'); };
                    header.ondragleave = () => groupDiv.classList.remove('drag-over');
                    header.ondrop = (e) => {
                        e.preventDefault();
                        groupDiv.classList.remove('drag-over');
                        if (draggedIndex !== index) {
                            const item = shiftCategories.splice(draggedIndex, 1)[0];
                            shiftCategories.splice(index, 0, item);
                            saveData(); createShiftButtons();
                        }
                    };
                    const title = document.createElement('h4');
                    title.className = 'flex items-center gap-2 text-base font-semibold text-gray-800 dark:text-gray-200';
                    const isCollapsed = collapsedCategories.has(category.name);
                    title.innerHTML = `<svg class="w-4 h-4 transition-transform ${isCollapsed ? '-rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>${category.name}`;
                    title.onclick = (e) => {
                        e.stopPropagation();
                        collapsedCategories.has(category.name) ? collapsedCategories.delete(category.name) : collapsedCategories.add(category.name);
                        saveData(); createShiftButtons();
                    };
                    header.appendChild(title);
                    groupDiv.appendChild(header);
                    const btnWrapper = document.createElement('div');
                    btnWrapper.className = `flex flex-wrap gap-2 pt-2 ${isCollapsed ? 'hidden' : ''}`;
                    for (const shiftName in category.shifts) {
                        const config = category.shifts[shiftName];
                        const btn = document.createElement('button');
                        btn.dataset.shift = shiftName;
                        btn.className = 'shift-button flex items-center justify-center gap-2 w-24 py-1.5 text-sm font-medium rounded-lg transition-all border-2 bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-500 text-gray-800 dark:text-gray-200';
                        btn.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${config ? config.c : '#6b7280'};"></span><span>${shiftName}</span>`;
                        btn.style.setProperty('--active-ring', config ? config.c : '#6b7280');
                        btn.style.setProperty('--card-bg', document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff');
                        btn.onclick = () => setActiveTool(shiftName);
                        btnWrapper.appendChild(btn);
                    }
                    groupDiv.appendChild(btnWrapper);
                    DOM.shiftSelectorButtons.appendChild(groupDiv);
                });
                setActiveTool(activeTool);
            };
            
            const updateSummaryDisplay = () => {
                let totalMinutes = 0;
                selectedDays.forEach((shiftData) => {
                    if (shiftData.start && shiftData.end) {
                        const [sh, sm] = shiftData.start.split(':').map(Number);
                        const [eh, em] = shiftData.end.split(':').map(Number);
                        if ([sh, sm, eh, em].some(isNaN)) return;
                        const sd = new Date(0); sd.setUTCHours(sh, sm);
                        const ed = new Date(0); ed.setUTCHours(eh, em);
                        if (ed < sd) ed.setDate(ed.getDate() + 1);
                        totalMinutes += (ed - sd) / 60000;
                    }
                });
                const totalHours = totalMinutes / 60;
                DOM.summaryDisplay.textContent = selectedDays.size > 0 ? `${selectedDays.size} Dienste / ${totalHours.toFixed(2)} Stunden` : 'Keine Dienste geplant';
            };

            const handleDayClick = (dateString) => {
                if (activeTool === 'Urlaub') {
                    if (!rangeSelectionStart) {
                        rangeSelectionStart = dateString;
                        renderCalendar();
                    } else {
                        const [startY, startM, startD] = rangeSelectionStart.split('-').map(Number);
                        const [endY, endM, endD] = dateString.split('-').map(Number);
                        
                        let startDate = new Date(Date.UTC(startY, startM - 1, startD));
                        let endDate = new Date(Date.UTC(endY, endM - 1, endD));

                        if (startDate > endDate) { [startDate, endDate] = [endDate, startDate]; }

                        for (let d = startDate; d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                            const currentDateStr = d.toISOString().slice(0, 10);
                            selectedDays.set(currentDateStr, { name: 'Urlaub', description: '', isCustom: false });
                        }
                        
                        rangeSelectionStart = null;
                        setActiveTool('Frei');
                    }
                } else {
                    const current = selectedDays.get(dateString);
                    if ((current && current.name === activeTool) || activeTool === 'Frei') { selectedDays.delete(dateString); } 
                    else {
                        let config = null;
                        shiftCategories.forEach(cat => { if (cat.shifts[activeTool]) config = cat.shifts[activeTool]; });
                        if (config) {
                            const newShiftData = { name: activeTool, description: '', isCustom: !!config.d, start: config.s, end: config.e };
                            if (config.d) { newShiftData.start = '08:00'; newShiftData.end = '17:00'; }
                            selectedDays.set(dateString, newShiftData);
                        }
                    }
                }
                selectedDays = new Map([...selectedDays.entries()].sort());
                fullRender();
                saveData();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                DOM.monthYear.textContent = `${new Intl.DateTimeFormat('de-DE', { month: 'long' }).format(currentDate)} ${year}`;
                DOM.calendarGrid.querySelectorAll('.calendar-day-container, .empty-day').forEach(el => el.remove());
                const firstDay = new Date(year, month, 1), daysInMonth = new Date(year, month + 1, 0).getDate();
                let startDayOfWeek = firstDay.getDay(); if (startDayOfWeek === 0) startDayOfWeek = 6; else startDayOfWeek -= 1;
                for (let i = 0; i < startDayOfWeek; i++) { const c=document.createElement('div'); c.className='empty-day'; DOM.calendarGrid.appendChild(c); }
                const today = new Date().toISOString().slice(0, 10);
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    const container = document.createElement('div');
                    container.className = 'calendar-day-container relative h-12 w-12 flex items-center justify-center cursor-pointer rounded-lg';
                    container.onclick = () => handleDayClick(dateStr);
                    const dayBg = document.createElement('div');
                    dayBg.className = 'calendar-day-bg absolute inset-0 rounded-lg group-hover:bg-blue-200 dark:group-hover:bg-blue-900';
                    
                    if (dayOfWeek === 6 || dayOfWeek === 0) { dayBg.classList.add('bg-gray-100', 'dark:bg-gray-700/50'); }
                    if (HOLIDAYS.has(dateStr)) { dayBg.classList.add('border-2', 'border-red-500'); }
                    if (dateStr === today) { dayBg.classList.add('border-2', 'border-blue-500'); }

                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = day;
                    dayNumber.className = 'z-10';
                    const shiftData = selectedDays.get(dateStr);
                    if (shiftData) {
                        let config = null;
                        shiftCategories.forEach(cat => { if (cat.shifts[shiftData.name]) config = cat.shifts[shiftData.name]; });
                        if (config) {
                            const isNightShift = ['RDN1', 'RDN2', 'TRN', 'NC206'].includes(shiftData.name);
                            if (isNightShift) {
                                dayBg.style.background = `linear-gradient(to bottom right, ${config.c} 49.5%, #9ca3af 50.5%)`;
                            } else {
                                dayBg.style.backgroundColor = config.c;
                            }
                            dayBg.style.opacity = '0.9';
                            dayNumber.classList.add('text-white', 'font-bold');
                        }
                    }
                    if (rangeSelectionStart === dateStr) {
                         dayBg.classList.add('border-4', 'border-green-500');
                    }
                    container.appendChild(dayBg);
                    container.appendChild(dayNumber);
                    DOM.calendarGrid.appendChild(container);
                }
            };

            const renderShiftList = () => {
                DOM.shiftList.innerHTML = '';
                if (selectedDays.size === 0) { DOM.shiftList.appendChild(DOM.noDayMsg); return; }
                selectedDays.forEach((shiftData, dateString) => {
                    const formattedDate = new Intl.DateTimeFormat('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }).format(new Date(dateString+'T00:00:00'));
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-100 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg space-y-2';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center flex-wrap gap-2';
                    const nameAndTimeSpan = document.createElement('span');
                    nameAndTimeSpan.className = 'font-semibold text-gray-800 dark:text-gray-100';
                    nameAndTimeSpan.textContent = `${formattedDate}: ${shiftData.name} `;
                    header.appendChild(nameAndTimeSpan);

                    if (shiftData.start && shiftData.end) {
                        const timeDisplay = document.createElement('span');
                        timeDisplay.className = 'text-sm text-gray-500 dark:text-gray-400 font-normal';
                        timeDisplay.textContent = `(${shiftData.start} - ${shiftData.end})`;
                        nameAndTimeSpan.appendChild(timeDisplay);
                    }
                    
                    item.appendChild(header);

                    let config = null;
                    shiftCategories.forEach(cat => { if (cat.shifts[shiftData.name]) config = cat.shifts[shiftData.name]; });
                    const isDynamicShift = config && config.d;

                    if (shiftData.start && shiftData.end) {
                        const inputsWrapper = document.createElement('div');
                        inputsWrapper.className = 'grid grid-cols-1 sm:grid-cols-3 gap-2 items-center';
                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'flex items-center gap-1';
                        const startTimeInput = document.createElement('input');
                        startTimeInput.type = 'time';
                        startTimeInput.value = shiftData.start;
                        startTimeInput.className = 'w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm disabled:bg-gray-200 dark:disabled:bg-gray-700';
                        const endTimeInput = document.createElement('input');
                        endTimeInput.type = 'time';
                        endTimeInput.value = shiftData.end;
                        endTimeInput.className = 'w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm disabled:bg-gray-200 dark:disabled:bg-gray-700';
                        const separator = document.createElement('span');
                        separator.className = 'text-gray-500';
                        separator.textContent = '-';
                        timeDiv.appendChild(startTimeInput);
                        timeDiv.appendChild(separator);
                        timeDiv.appendChild(endTimeInput);
                        const descInput = document.createElement('input');
                        descInput.type = 'text';
                        descInput.placeholder = 'Beschreibung (optional)';
                        descInput.value = shiftData.description;
                        descInput.className = 'sm:col-span-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm';

                        if (!isDynamicShift) {
                            const customTimeLabel = document.createElement('label');
                            customTimeLabel.className = 'flex items-center text-sm cursor-pointer';
                            const customTimeCheckbox = document.createElement('input');
                            customTimeCheckbox.type = 'checkbox';
                            customTimeCheckbox.checked = shiftData.isCustom;
                            customTimeCheckbox.className = 'h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-100 dark:bg-gray-900';
                            customTimeLabel.appendChild(customTimeCheckbox);
                            customTimeLabel.append(' Eigene Zeiten');
                            header.appendChild(customTimeLabel);

                            inputsWrapper.classList.toggle('hidden', !shiftData.isCustom);
                            startTimeInput.disabled = !shiftData.isCustom;
                            endTimeInput.disabled = !shiftData.isCustom;

                            customTimeCheckbox.onchange = (e) => {
                                shiftData.isCustom = e.target.checked;
                                inputsWrapper.classList.toggle('hidden', !shiftData.isCustom);
                                startTimeInput.disabled = !shiftData.isCustom;
                                endTimeInput.disabled = !shiftData.isCustom;
                                if (!shiftData.isCustom) {
                                    if (config && config.s && config.e) {
                                        shiftData.start = config.s;
                                        shiftData.end = config.e;
                                        startTimeInput.value = shiftData.start;
                                        endTimeInput.value = shiftData.end;
                                        nameAndTimeSpan.querySelector('span').textContent = `(${shiftData.start} - ${shiftData.end})`;
                                    }
                                }
                                updateSummaryDisplay(); saveData();
                            };
                        }
                        
                        const timeUpdateHandler = () => { shiftData.start = startTimeInput.value; shiftData.end = endTimeInput.value; nameAndTimeSpan.querySelector('span').textContent = `(${shiftData.start} - ${shiftData.end})`; updateSummaryDisplay(); saveData(); };
                        startTimeInput.onchange = timeUpdateHandler;
                        endTimeInput.onchange = timeUpdateHandler;
                        descInput.oninput = (e) => { shiftData.description = e.target.value; saveData(); };
                        
                        inputsWrapper.appendChild(timeDiv);
                        inputsWrapper.appendChild(descInput);
                        item.appendChild(inputsWrapper);
                    }
                    DOM.shiftList.appendChild(item);
                });
            };

            const renderStatistics = () => {
                let istMinutes = 0, feiertagMinutes = 0, nachtMinutes = 0, urlaubDays = 0, workedWeekends = 0, workedHolidays = 0;
                const categoryCounts = {};
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let workingDays = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(Date.UTC(year, month, day));
                    const dayOfWeek = date.getUTCDay();
                    const dateStr = date.toISOString().slice(0, 10);
                    if (dayOfWeek >= 1 && dayOfWeek <= 5 && !HOLIDAYS.has(dateStr)) {
                        workingDays++;
                    }
                }
                const calculatedSollStunden = workingDays * 8;
                DOM.statSoll.textContent = `${calculatedSollStunden.toFixed(2)} h`;

                selectedDays.forEach((data, dateStr) => {
                    const dayOfWeek = new Date(dateStr + 'T12:00:00').getDay();
                    const isHoliday = HOLIDAYS.has(dateStr);
                    
                    if (data.name === 'Urlaub') {
                        if (dayOfWeek !== 0 && dayOfWeek !== 6) { urlaubDays++; }
                        return;
                    }

                    if (dayOfWeek === 0 || dayOfWeek === 6) workedWeekends++;
                    if (isHoliday) workedHolidays++;

                    if (data.start && data.end) {
                        const [sh, sm] = data.start.split(':').map(Number);
                        const [eh, em] = data.end.split(':').map(Number);
                        if ([sh, sm, eh, em].some(isNaN)) return;
                        const startMinutes = sh * 60 + sm;
                        let endMinutes = eh * 60 + em;
                        if (endMinutes < startMinutes) endMinutes += 24 * 60;
                        const duration = endMinutes - startMinutes;
                        istMinutes += duration;
                        if (isHoliday) feiertagMinutes += duration;
                        const nightStart = 22 * 60;
                        const nightEnd = 5 * 60 + 24 * 60;
                        const overlap = Math.max(0, Math.min(endMinutes, nightEnd) - Math.max(startMinutes, nightStart));
                        nachtMinutes += overlap;
                    }

                    let categoryName = 'Sonstiges';
                    for (const cat of shiftCategories) {
                        if (cat.shifts[data.name]) { categoryName = cat.name; break; }
                    }
                    categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
                });

                DOM.statIst.textContent = `${(istMinutes / 60).toFixed(2)} h`;
                DOM.statFeiertag.textContent = `${(feiertagMinutes / 60).toFixed(2)} h`;
                DOM.statNacht.textContent = `${(nachtMinutes / 60).toFixed(2)} h`;
                DOM.statUrlaub.textContent = `${urlaubDays * 8} h`;
                DOM.statWochenende.textContent = `${workedWeekends}`;
                DOM.statFeiertageAnzahl.textContent = `${workedHolidays}`;

                if (shiftChart) shiftChart.destroy();
                const chartLabels = Object.keys(categoryCounts).map(name => CATEGORY_ABBREVIATIONS[name] || name);
                const chartData = {
                    labels: chartLabels,
                    datasets: [{
                        data: Object.values(categoryCounts),
                        backgroundColor: Object.keys(categoryCounts).map(name => {
                            const cat = shiftCategories.find(c => c.name === name);
                            if (cat) {
                                const firstShift = Object.values(cat.shifts)[0];
                                return firstShift ? firstShift.c : '#cccccc';
                            }
                            return '#cccccc';
                        }),
                        borderWidth: 0,
                    }]
                };
                shiftChart = new Chart(DOM.chartCanvas, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#4b5563',
                                    boxWidth: 12,
                                    padding: 15,
                                }
                            }
                        }
                    }
                });
            };
            
            const updateGenerateButtonState = () => { 
                const disabled = selectedDays.size === 0;
                DOM.generateBtn.disabled = disabled;
                DOM.emailBtn.disabled = disabled;
            };

            const generateICSContent = () => {
                let ics = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//DeinDienstplan//NONSGML v1.0//DE','CALSCALE:GREGORIAN'].join('\r\n');
                const ts = new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
                
                const otherShifts = new Map([...selectedDays].filter(([k,v]) => v.name !== 'Urlaub'));
                const vacationDays = [...selectedDays].filter(([k,v]) => v.name === 'Urlaub').map(([k,v]) => k).sort();

                otherShifts.forEach((data, dateStr) => {
                    if(!data.start || !data.end) return;
                    const holidayName = HOLIDAYS.get(dateStr);
                    const userDescription = data.description;
                    let details = [];
                    if (holidayName) details.push(holidayName);
                    if (userDescription) details.push(userDescription);
                    const summary = details.length > 0 ? `${data.name} (${details.join(' / ')})` : data.name;
                    
                    let icsEvent = [
                        'BEGIN:VEVENT',
                        `UID:dienstplan-${dateStr}-${summary.replace(/\s/g,'')}@dein.dienstplan`,
                        `DTSTAMP:${ts}`
                    ];

                    const[y,m,d]=dateStr.split('-').map(Number),[sh,sm]=data.start.split(':').map(Number),[eh,em]=data.end.split(':').map(Number);
                    if([sh,sm,eh,em].some(isNaN)) return;
                    let sd=new Date(Date.UTC(y,m-1,d,sh,sm)),ed=new Date(Date.UTC(y,m-1,d,eh,em));
                    if(ed<sd)ed.setDate(ed.getDate()+1);
                    const format=dt=>dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
                    
                    icsEvent.push(`DTSTART:${format(sd)}`);
                    icsEvent.push(`DTEND:${format(ed)}`);
                    icsEvent.push(`SUMMARY:${summary}`);
                    icsEvent.push(`LOCATION:Hunoldstraße 17a, A-6020 Innsbruck`);

                    let categoryName = '';
                    for (const cat of shiftCategories) {
                        if (cat.shifts[data.name]) {
                            categoryName = cat.name;
                            break;
                        }
                    }

                    if (categoryName === 'Notfallrettung') {
                        icsEvent.push('CATEGORIES:NR');
                    } else if (categoryName === 'Technische Rettung') {
                        icsEvent.push('CATEGORIES:FW');
                    } else if (categoryName === 'Callcenter') {
                        icsEvent.push('CATEGORIES:NC');
                    } else if (data.name === 'S') {
                        icsEvent.push('CATEGORIES:Sonderschicht');
                    }

                    icsEvent.push('END:VEVENT');
                    ics += '\r\n' + icsEvent.join('\r\n');
                });

                let i = 0;
                while (i < vacationDays.length) {
                    const [startY, startM, startD] = vacationDays[i].split('-').map(Number);
                    let startDate = new Date(Date.UTC(startY, startM - 1, startD));
                    let endDate = new Date(startDate);
                    let j = i + 1;
                    while (j < vacationDays.length) {
                        const [nextY, nextM, nextD] = vacationDays[j].split('-').map(Number);
                        let nextDay = new Date(Date.UTC(nextY, nextM - 1, nextD));
                        let expectedNextDay = new Date(endDate);
                        expectedNextDay.setUTCDate(expectedNextDay.getUTCDate() + 1);
                        if (nextDay.getTime() === expectedNextDay.getTime()) {
                            endDate = nextDay;
                            j++;
                        } else { break; }
                    }
                    const formatDt = (d) => d.toISOString().slice(0,10).replace(/-/g, '');
                    const dtStart = formatDt(startDate);
                    endDate.setUTCDate(endDate.getUTCDate() + 1);
                    const dtEnd = formatDt(endDate);
                    const uid = `dienstplan-urlaub-${dtStart}@dein.dienstplan`;
                    ics += `\r\nBEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${ts}\r\nDTSTART;VALUE=DATE:${dtStart}\r\nDTEND;VALUE=DATE:${dtEnd}\r\nSUMMARY:Urlaub\r\nCATEGORIES:Urlaub/FW\r\nEND:VEVENT`;
                    i = j;
                }
                return ics+'\r\nEND:VCALENDAR';
            };

            const downloadICS = () => {
                const blob = new Blob([generateICSContent()], {type:'text/calendar;charset=utf-8'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Dienstplan_${new Intl.DateTimeFormat('de-DE',{month:'long'}).format(currentDate)}_${currentDate.getFullYear()}.ics`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const generateEmail = () => {
                if (selectedDays.size === 0) return;
                const monthName = new Intl.DateTimeFormat('de-DE', { month: 'long' }).format(currentDate);
                const year = currentDate.getFullYear();
                const subject = `Dienstplan für ${monthName} ${year}`;
                let bodyLines = ['Hallo,', '', 'hier ist der Dienstplan:', ''];
                selectedDays.forEach((data, dateStr) => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const formattedDate = new Intl.DateTimeFormat('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }).format(date);
                    let line = `${formattedDate}: ${data.name}`;
                    if(data.start && data.end) { line += ` (${data.start} - ${data.end})`; }
                    const holidayName = HOLIDAYS.get(dateStr);
                    const userDescription = data.description;
                    let details = [];
                    if (holidayName) details.push(holidayName);
                    if (userDescription) details.push(userDescription);
                    if (details.length > 0) { line += ` (${details.join(' / ')})`; }
                    bodyLines.push(line);
                });
                const body = bodyLines.join('\n');
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            };
            
            const handleThemeToggle = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateIconVisibility(isDark);
                createShiftButtons();
                renderStatistics(); // Re-render chart with correct text color
            };

            const updateIconVisibility = (isDark) => {
                const themeIconLight = document.getElementById('theme-icon-light');
                const themeIconDark = document.getElementById('theme-icon-dark');
                if (themeIconLight && themeIconDark) {
                    themeIconLight.classList.toggle('hidden', !isDark);
                    themeIconLight.classList.toggle('block', isDark);
                    themeIconDark.classList.toggle('hidden', isDark);
                    themeIconDark.classList.toggle('block', !isDark);
                }
            };

            const fullRender = () => {
                renderCalendar();
                renderShiftList();
                renderStatistics();
                updateSummaryDisplay();
                updateGenerateButtonState();
            };

            DOM.themeToggle.onclick = handleThemeToggle;
            document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); loadData(); };
            document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); loadData(); };
            DOM.generateBtn.onclick = downloadICS;
            DOM.emailBtn.onclick = generateEmail;
            DOM.clearPlanBtn.onclick = clearData;

            // Initial setup
            loadData();
            createShiftButtons();
            updateIconVisibility(document.documentElement.classList.contains('dark'));
        });
    </script>
</body>
</html>
