<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }
        .shift-button.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--card-bg, #fff), 0 0 0 4px var(--active-ring, #2563eb);
        }
        #save-indicator {
            transition: opacity 0.5s ease-in-out;
        }
        .card, .calendar-day-bg {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .calendar-day-container {
            transition: transform 0.1s ease-out;
        }
        .calendar-day-container:hover {
            transform: scale(1.08);
        }
    </style>
    <script>
        // Set theme on initial load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dienstplan-Editor</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Dein Plan wird automatisch im Browser gespeichert.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 focus:ring-blue-500">
                <!-- Sun icon, shown in dark mode -->
                <svg id="theme-icon-light" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <!-- Moon icon, shown in light mode -->
                <svg id="theme-icon-dark" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Card: Shift Selection -->
                <div class="card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-semibold text-gray-900 dark:text-white">1. Schicht auswählen</h3>
                         <span id="save-indicator" class="text-sm text-green-500 opacity-0 font-medium">Gespeichert!</span>
                    </div>
                    <span id="summary-display" class="block text-sm text-gray-500 dark:text-gray-400 mb-4">Keine Dienste geplant</span>
                    <div id="shift-selector-buttons" class="space-y-4 mt-3"></div>
                </div>

                <!-- Card: Statistics -->
                <div class="card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Detaillierte Statistik</h3>
                    <div id="statistics-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <p id="no-stats-msg" class="text-gray-500 dark:text-gray-400 col-span-full">Noch keine Dienste für eine Statistik vorhanden.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Card: Calendar -->
                <div class="card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">2. Tage zuweisen</h3>
                        <button id="clear-plan" class="text-sm text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold">Plan zurücksetzen</button>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                        <h2 id="month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                        <div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Mo</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Di</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Mi</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Do</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Fr</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Sa</div><div class="font-semibold text-gray-500 dark:text-gray-400 text-sm">So</div>
                    </div>
                </div>
                
                <!-- Card: Summary & Export -->
                <div class="card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                     <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Zusammenfassung & Bearbeitung</h3>
                     <div id="shift-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                         <p id="no-day-selected-msg" class="text-gray-500 dark:text-gray-400">Keine Tage zugewiesen.</p>
                     </div>
                     <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
                        <button id="generate-ics" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 focus:ring-blue-500 transition-all disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                            ICS-Datei erstellen & herunterladen
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SHIFT_CONFIG = {
                'Notfallrettung': { 'RD1':{s:'06:30',e:'16:30',c:'#ef4444'},'RD2':{s:'07:00',e:'17:00',c:'#ef4444'},'RD3w':{s:'09:00',e:'19:00',c:'#ef4444'},'RD3s':{s:'09:30',e:'19:30',c:'#ef4444'},'RD4':{s:'11:00',e:'21:00',c:'#ef4444'},'RD5':{s:'10:00',e:'20:00',c:'#ef4444'},'RDN1':{s:'19:00',e:'05:00',c:'#ef4444'},'RDN2':{s:'21:00',e:'07:00',c:'#ef4444'}},
                'Technische Rettung': { 'TR1':{s:'06:45',e:'16:45',c:'#8b5cf6'},'TR2':{s:'10:45',e:'20:45',c:'#8b5cf6'},'TR3':{s:'08:00',e:'18:00',c:'#8b5cf6'},'TRN':{s:'20:45',e:'06:45',c:'#8b5cf6'}},
                'Sonstiges': { 'S':{c:'#f97316',d:!0},'Frei':null}
            };

            let currentDate = new Date();
            let selectedDays = new Map();
            let activeShift = 'Frei';
            let saveTimeout;

            const DOM = {
                monthYear: document.getElementById('month-year'),
                calendarGrid: document.getElementById('calendar-grid'),
                shiftList: document.getElementById('shift-list'),
                noDayMsg: document.getElementById('no-day-selected-msg'),
                generateBtn: document.getElementById('generate-ics'),
                shiftSelectorButtons: document.getElementById('shift-selector-buttons'),
                summaryDisplay: document.getElementById('summary-display'),
                saveIndicator: document.getElementById('save-indicator'),
                clearPlanBtn: document.getElementById('clear-plan'),
                statisticsList: document.getElementById('statistics-list'),
                noStatsMsg: document.getElementById('no-stats-msg'),
                themeToggle: document.getElementById('theme-toggle'),
                themeIconLight: document.getElementById('theme-icon-light'),
                themeIconDark: document.getElementById('theme-icon-dark'),
            };

            const getStorageKey = () => `dienstplan-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
            const showSaveIndicator = () => { clearTimeout(saveTimeout); DOM.saveIndicator.style.opacity = 1; saveTimeout = setTimeout(() => { DOM.saveIndicator.style.opacity = 0; }, 2000); };
            const saveData = () => { try { localStorage.setItem(getStorageKey(), JSON.stringify(Array.from(selectedDays.entries()))); showSaveIndicator(); } catch (e) { console.error("Speichern fehlgeschlagen:", e); } };
            
            const loadData = () => {
                try {
                    const savedData = localStorage.getItem(getStorageKey());
                    if (savedData) {
                        const parsedMap = new Map(JSON.parse(savedData));
                        parsedMap.forEach((data, key) => {
                            if (typeof data === 'string' || !data.hasOwnProperty('name')) {
                                const shiftName = (typeof data === 'string') ? data : data.name;
                                let config = null;
                                for (const group in SHIFT_CONFIG) { if (SHIFT_CONFIG[group][shiftName]) { config = SHIFT_CONFIG[group][shiftName]; break; }}
                                if (config) {
                                    parsedMap.set(key, {
                                        name: shiftName,
                                        start: config.s || '08:00',
                                        end: config.e || '17:00',
                                        description: (typeof data === 'object' && data.description) ? data.description : '',
                                        isCustom: (typeof data === 'object' && data.isCustom) ? data.isCustom : !!config.d
                                    });
                                } else { parsedMap.delete(key); }
                            }
                        });
                        selectedDays = parsedMap;
                    } else { selectedDays = new Map(); }
                } catch (e) { console.error("Laden fehlgeschlagen:", e); localStorage.removeItem(getStorageKey()); selectedDays = new Map(); }
                fullRender();
            };

            const clearData = () => {
                // Using a simple confirm dialog. For a more styled approach, a custom modal would be needed.
                if (window.confirm("Bist du sicher, dass du den gesamten Plan für diesen Monat löschen möchtest?")) {
                    localStorage.removeItem(getStorageKey());
                    selectedDays = new Map();
                    fullRender();
                }
            };
            const setActiveShift = (name) => { activeShift = name; document.querySelectorAll('.shift-button').forEach(b => b.classList.toggle('active', b.dataset.shift === name)); };

            const createShiftButtons = () => {
                DOM.shiftSelectorButtons.innerHTML = '';
                for (const groupName in SHIFT_CONFIG) {
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<h4 class="text-base font-semibold text-gray-800 dark:text-gray-200 mb-2">${groupName}</h4>`;
                    const btnWrapper = document.createElement('div');
                    btnWrapper.className = 'flex flex-wrap gap-2';
                    for (const shiftName in SHIFT_CONFIG[groupName]) {
                        const config = SHIFT_CONFIG[groupName][shiftName];
                        const btn = document.createElement('button');
                        btn.textContent = shiftName;
                        btn.dataset.shift = shiftName;
                        btn.className = 'shift-button px-3 py-1.5 text-sm font-medium rounded-lg transition-all border-2';
                        btn.style.borderColor = config ? config.c : '#6b7280';
                        btn.style.color = config ? config.c : '#6b7280';
                        btn.style.setProperty('--active-ring', config ? config.c : '#6b7280');
                        btn.style.setProperty('--card-bg', document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff');
                        btn.onclick = () => setActiveShift(shiftName);
                        btnWrapper.appendChild(btn);
                    }
                    groupDiv.appendChild(btnWrapper);
                    DOM.shiftSelectorButtons.appendChild(groupDiv);
                }
                setActiveShift(activeShift);
            };
            
            const updateSummaryDisplay = () => {
                let totalMinutes = 0;
                selectedDays.forEach((shiftData) => {
                    if (shiftData.start && shiftData.end) {
                        const [sh, sm] = shiftData.start.split(':').map(Number);
                        const [eh, em] = shiftData.end.split(':').map(Number);
                        if ([sh, sm, eh, em].some(isNaN)) return;
                        const sd = new Date(0); sd.setUTCHours(sh, sm);
                        const ed = new Date(0); ed.setUTCHours(eh, em);
                        if (ed < sd) ed.setDate(ed.getDate() + 1);
                        totalMinutes += (ed - sd) / 60000;
                    }
                });
                const totalHours = totalMinutes / 60;
                DOM.summaryDisplay.textContent = selectedDays.size > 0 ? `${selectedDays.size} Dienste / ${totalHours.toFixed(2)} Stunden` : 'Keine Dienste geplant';
            };

            const handleDayClick = (dateString) => {
                const current = selectedDays.get(dateString);
                if ((current && current.name === activeShift) || activeShift === 'Frei') { selectedDays.delete(dateString); } 
                else {
                    let config = null;
                    for (const group in SHIFT_CONFIG) { if (SHIFT_CONFIG[group][activeShift]) { config = SHIFT_CONFIG[group][activeShift]; break; } }
                    if (config) {
                        selectedDays.set(dateString, {
                            name: activeShift,
                            start: config.s || '08:00',
                            end: config.e || '17:00',
                            description: '',
                            isCustom: !!config.d
                        });
                    }
                }
                selectedDays = new Map([...selectedDays.entries()].sort());
                fullRender();
                saveData();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                DOM.monthYear.textContent = `${new Intl.DateTimeFormat('de-DE', { month: 'long' }).format(currentDate)} ${year}`;
                DOM.calendarGrid.querySelectorAll('.calendar-day-container, .empty-day').forEach(el => el.remove());
                const firstDay = new Date(year, month, 1), daysInMonth = new Date(year, month + 1, 0).getDate();
                let startDay = firstDay.getDay(); if (startDay === 0) startDay = 6; else startDay -= 1;
                for (let i = 0; i < startDay; i++) { const c=document.createElement('div'); c.className='empty-day'; DOM.calendarGrid.appendChild(c); }
                const today = new Date().toISOString().slice(0, 10);
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const container = document.createElement('div');
                    container.className = 'calendar-day-container relative h-12 w-12 flex items-center justify-center cursor-pointer rounded-lg';
                    container.onclick = () => handleDayClick(dateStr);
                    const dayBg = document.createElement('div');
                    dayBg.className = 'calendar-day-bg absolute inset-0 rounded-lg group-hover:bg-blue-200 dark:group-hover:bg-blue-900';
                    if (dateStr === today) dayBg.classList.add('border-2', 'border-blue-500');
                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = day;
                    dayNumber.className = 'z-10';
                    const shiftData = selectedDays.get(dateStr);
                    if (shiftData) {
                        let config = null;
                        for(const g in SHIFT_CONFIG) if(SHIFT_CONFIG[g][shiftData.name]) config = SHIFT_CONFIG[g][shiftData.name];
                        if (config) {
                            const isNightShift = ['RDN1', 'RDN2', 'TRN'].includes(shiftData.name);
                            if (isNightShift) {
                                dayBg.style.background = `linear-gradient(to bottom right, ${config.c} 49.5%, #9ca3af 50.5%)`;
                            } else {
                                dayBg.style.backgroundColor = config.c;
                            }
                            dayBg.style.opacity = '0.9';
                            dayNumber.classList.add('text-white', 'font-bold');
                        }
                    }
                    container.appendChild(dayBg);
                    container.appendChild(dayNumber);
                    DOM.calendarGrid.appendChild(container);
                }
            };

            const renderShiftList = () => {
                DOM.shiftList.innerHTML = '';
                if (selectedDays.size === 0) { DOM.shiftList.appendChild(DOM.noDayMsg); return; }
                selectedDays.forEach((shiftData, dateString) => {
                    const formattedDate = new Intl.DateTimeFormat('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }).format(new Date(dateString+'T00:00:00'));
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-100 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg space-y-2';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center flex-wrap gap-2';
                    const nameAndTimeSpan = document.createElement('span');
                    nameAndTimeSpan.className = 'font-semibold text-gray-800 dark:text-gray-100';
                    nameAndTimeSpan.textContent = `${formattedDate}: ${shiftData.name} `;
                    const timeDisplay = document.createElement('span');
                    timeDisplay.className = 'text-sm text-gray-500 dark:text-gray-400 font-normal';
                    timeDisplay.textContent = `(${shiftData.start} - ${shiftData.end})`;
                    nameAndTimeSpan.appendChild(timeDisplay);
                    header.appendChild(nameAndTimeSpan);
                    const customTimeLabel = document.createElement('label');
                    customTimeLabel.className = 'flex items-center text-sm cursor-pointer';
                    const customTimeCheckbox = document.createElement('input');
                    customTimeCheckbox.type = 'checkbox';
                    customTimeCheckbox.checked = shiftData.isCustom;
                    customTimeCheckbox.className = 'h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-100 dark:bg-gray-900';
                    customTimeLabel.appendChild(customTimeCheckbox);
                    customTimeLabel.append(' Eigene Zeiten');
                    header.appendChild(customTimeLabel);
                    const inputsWrapper = document.createElement('div');
                    inputsWrapper.className = 'grid grid-cols-1 sm:grid-cols-3 gap-2 items-center';
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'flex items-center gap-1';
                    const startTimeInput = document.createElement('input');
                    startTimeInput.type = 'time';
                    startTimeInput.value = shiftData.start;
                    startTimeInput.disabled = !shiftData.isCustom;
                    startTimeInput.className = 'w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm disabled:bg-gray-200 dark:disabled:bg-gray-700';
                    const endTimeInput = document.createElement('input');
                    endTimeInput.type = 'time';
                    endTimeInput.value = shiftData.end;
                    endTimeInput.disabled = !shiftData.isCustom;
                    endTimeInput.className = 'w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm disabled:bg-gray-200 dark:disabled:bg-gray-700';
                    timeDiv.appendChild(startTimeInput);
                    timeDiv.innerHTML += `<span class="text-gray-500">-</span>`;
                    timeDiv.appendChild(endTimeInput);
                    const descInput = document.createElement('input');
                    descInput.type = 'text';
                    descInput.placeholder = 'Beschreibung (optional)';
                    descInput.value = shiftData.description;
                    descInput.className = 'sm:col-span-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-1 text-sm';
                    customTimeCheckbox.onchange = (e) => {
                        shiftData.isCustom = e.target.checked;
                        startTimeInput.disabled = !shiftData.isCustom;
                        endTimeInput.disabled = !shiftData.isCustom;
                        if (!shiftData.isCustom) {
                            let config = null;
                            for (const group in SHIFT_CONFIG) { if (SHIFT_CONFIG[group][shiftData.name]) { config = SHIFT_CONFIG[group][shiftData.name]; break; } }
                            if (config && config.s && config.e) {
                                shiftData.start = config.s;
                                shiftData.end = config.e;
                                startTimeInput.value = shiftData.start;
                                endTimeInput.value = shiftData.end;
                                timeDisplay.textContent = `(${shiftData.start} - ${shiftData.end})`;
                            }
                        }
                        updateSummaryDisplay(); saveData();
                    };
                    const timeUpdateHandler = () => { shiftData.start = startTimeInput.value; shiftData.end = endTimeInput.value; timeDisplay.textContent = `(${shiftData.start} - ${shiftData.end})`; updateSummaryDisplay(); saveData(); };
                    startTimeInput.onchange = timeUpdateHandler;
                    endTimeInput.onchange = timeUpdateHandler;
                    descInput.oninput = (e) => { shiftData.description = e.target.value; saveData(); };
                    inputsWrapper.appendChild(timeDiv);
                    inputsWrapper.appendChild(descInput);
                    item.appendChild(header);
                    item.appendChild(inputsWrapper);
                    DOM.shiftList.appendChild(item);
                });
            };

            const renderStatistics = () => {
                DOM.statisticsList.innerHTML = '';
                const shiftCounts = {};
                if (selectedDays.size === 0) { DOM.statisticsList.appendChild(DOM.noStatsMsg); return; }
                for (const shiftData of selectedDays.values()) { shiftCounts[shiftData.name] = (shiftCounts[shiftData.name] || 0) + 1; }
                const sortedShifts = Object.entries(shiftCounts).sort((a, b) => b[1] - a[1]);
                for (const [shiftName, count] of sortedShifts) {
                    const statBox = document.createElement('div');
                    statBox.className = 'bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg text-center';
                    let color = '#6b7280';
                    for (const group in SHIFT_CONFIG) if(SHIFT_CONFIG[group][shiftName]) color = SHIFT_CONFIG[group][shiftName].c;
                    statBox.innerHTML = `<div class="text-2xl font-bold" style="color: ${color};">${count}x</div><div class="text-sm text-gray-800 dark:text-gray-200 font-medium">${shiftName}</div>`;
                    DOM.statisticsList.appendChild(statBox);
                }
            };
            
            const updateGenerateButtonState = () => { DOM.generateBtn.disabled = selectedDays.size === 0; };

            const generateICSContent = () => {
                let ics = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//DeinDienstplan//NONSGML v1.0//DE','CALSCALE:GREGORIAN'].join('\r\n');
                const ts = new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
                selectedDays.forEach((data, dateStr) => {
                    if(!data.start || !data.end) return;
                    const summary = data.description ? `${data.name} (${data.description})` : data.name;
                    const[y,m,d]=dateStr.split('-').map(Number),[sh,sm]=data.start.split(':').map(Number),[eh,em]=data.end.split(':').map(Number);
                    if([sh,sm,eh,em].some(isNaN)) return;
                    let sd=new Date(Date.UTC(y,m-1,d,sh,sm)),ed=new Date(Date.UTC(y,m-1,d,eh,em));
                    if(ed<sd)ed.setDate(ed.getDate()+1);
                    const format=dt=>dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
                    const uid=`dienstplan-${dateStr}-${summary.replace(/\s/g,'')}@dein.dienstplan`;
                    ics+=`\r\nBEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${ts}\r\nDTSTART:${format(sd)}\r\nDTEND:${format(ed)}\r\nSUMMARY:${summary}\r\nLOCATION:Hunoldstraße 17a, A-6020 Innsbruck\r\nEND:VEVENT`;
                });
                return ics+'\r\nEND:VCALENDAR';
            };

            const downloadICS = () => {
                const blob = new Blob([generateICSContent()], {type:'text/calendar;charset=utf-8'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Dienstplan_${new Intl.DateTimeFormat('de-DE',{month:'long'}).format(currentDate)}_${currentDate.getFullYear()}.ics`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };
            
            const handleThemeToggle = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                createShiftButtons();
                setActiveShift(activeShift);
            };

            const fullRender = () => {
                renderCalendar();
                renderShiftList();
                renderStatistics();
                updateSummaryDisplay();
                updateGenerateButtonState();
            };

            DOM.themeToggle.onclick = handleThemeToggle;
            document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); loadData(); };
            document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); loadData(); };
            DOM.generateBtn.onclick = downloadICS;
            DOM.clearPlanBtn.onclick = clearData;

            // Initial setup
            createShiftButtons();
            loadData();
        });
    </script>
</body>
</html>
